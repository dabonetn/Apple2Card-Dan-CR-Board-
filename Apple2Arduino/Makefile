# Makefile - build "Arduino" firmware image.
#
#  Copyright (c) 2023 Thorsten C. Brehm
#
#  This software is provided 'as-is', without any express or implied
#  warranty. In no event will the authors be held liable for any damages
#  arising from the use of this software.
#
#  Permission is granted to anyone to use this software for any purpose,
#  including commercial applications, and to alter it and redistribute it
#  freely, subject to the following restrictions:
#
#  1. The origin of this software must not be misrepresented; you must not
#     claim that you wrote the original software. If you use this software
#     in a product, an acknowledgment in the product documentation would be
#     appreciated but is not required.
#  2. Altered source versions must be plainly marked as such, and must not be
#     misrepresented as being the original software.
#  3. This notice may not be removed or altered from any source distribution.

include ../version.mk

FW_VERSION_MAJOR := $(word 1,$(subst ., ,$(FW_VERSION)))
FW_VERSION_MINOR := $(word 2,$(subst ., ,$(FW_VERSION)))
FW_VERSION_MAINT := $(word 3,$(subst ., ,$(FW_VERSION)))

# optional local file with user environment (i.e. path to Arduino build utilities)
-include ../localsettings.mk

SOURCES		:= $(wildcard *.ino *.c *.cpp *.h)

PLATFORM_PATH	:= $(realpath .)
BUILD_PROPERTIES := --build-property "runtime.platform.path=$(PLATFORM_PATH)"

# build for ATMEGA "328P" or "644P"? (select by calling 'make ATMEGA_TYPE=328P' or 'make ATMEGA_TYPE=644P')
ATMEGA_TYPE ?= 328P

# Allow verbose make using $ make V=1
ifeq ($(V),1)
Q 		:=
else
Q 		:= @
endif


# clear variable (used as a check if a valid ATMEGA_TYPE was selected)
DSTDIR :=

# Bootloaders are located at:
# https://github.com/ThorstenBr/MiniCoreDAN2Controller.git
ifeq ($(strip $(ATMEGA_TYPE)),328P)
DSTDIR		:= bin-328p
BOARD		:= arduino:avr:uno
HEX_FILE	:= Apple2Arduino.ino.328p.with_bootloader.hex
# Override default Arduino Uno settings and provide a custom bootloader
# (must be stored in a "bootloaders" subdirectory, since that's hardcoded in the Arduino environment)
BOOTLOADER	:= optiboot_atmega328p_DANII_16000000L.hex
BUILD_PROPERTIES += --build-property "bootloader.file=$(BOOTLOADER)"
endif

ifeq ($(strip $(ATMEGA_TYPE)),644P)
# this requires external 'core' libraries for the Atmega644
# wget http://www.leonardomiliani.com/repository/package_leonardomiliani.com_index.json
# mv package_leonardomiliani.com_index.json ~/.arduino15/
# arduino-cli --additional-urls package_leonardomiliani.com_index.json core install megax4:avr
DSTDIR		:= bin-644p
HEX_FILE	:= Apple2Arduino.ino.644p.with_bootloader.hex
BOARD		:= megax4:avr:atmegax4:cpu=644_16b
# cd MiniCoreDAN2Controller/avr/bootloaders/optiboot_flash
# make atmega644p AVR_FREQ=16000000L DANII=1 GCCROOT=
BOOTLOADER	:= optiboot_flash_atmega644p_UART_DANII_16000000L_NOLED.hex
BUILD_PROPERTIES += --build-property "bootloader.file=$(BOOTLOADER)"
endif

ifeq ($(DSTDIR),)
  DUMMY := $(error ERROR: Unknown DAN][ hardware type: '$(ATMEGA_TYPE)'. Currently supported types: '328P' or '644P'.)
endif

# set localisation to default, so arduino-cli log output does not depend on system language, but is always in english
export LC_ALL:=C

.PHONY: all build

all: $(DSTDIR) build

DSTDIR:
	- mkdir $(DSTDIR)

build: $(DSTDIR)/CHECKSETUP $(HEX_FILE)

fwversion.h: ../version.mk
	@(echo "// AUTOGENERATED FILE"; echo "#define FW_VERSION \"$(FW_VERSION)\"") > $@_
	@(echo "#define FW_VERSION_MAJOR $(FW_VERSION_MAJOR)") >> $@_
	@(echo "#define FW_VERSION_MINOR $(FW_VERSION_MINOR)") >> $@_
	@(echo "#define FW_VERSION_MAINT $(FW_VERSION_MAINT)") >> $@_
	$(Q)mv $@_ $@

# Check is arduino-cli is properly installed (donce once only)
$(DSTDIR)/CHECKSETUP:
	$(Q)arduino-cli help > /dev/null || \
		(echo "ERROR: You need at least $$ arduino-cli core install arduino:avr and $$ arduino-cli lib install Ethernet"; false)
	@touch $@ # no need to run the check again

# build and add custom bootloader
$(HEX_FILE): $(SOURCES) fwversion.h bootloaders/$(BOOTLOADER) | $(DSTDIR)
	$(Q)arduino-cli compile -b $(BOARD) $(BUILD_PROPERTIES) \
		--clean --output-dir $(DSTDIR) Apple2Arduino.ino > $(DSTDIR)/build.log
	$(Q)cat $(DSTDIR)/build.log
	$(Q)cp $(DSTDIR)/Apple2Arduino.ino.with_bootloader.hex $@

clean:
	$(Q)rm -f $(DSTDIR)/*.eep $(DSTDIR)/*.elf $(DSTDIR)/*.hex $(DSTDIR)/*.bin $(DSTDIR)/CHECKSETUP $(DSTDIR)/build.log fwversion.h $(HEX_FILE)

$(DSTDIR):
	$(Q)mkdir -p $(DSTDIR)
